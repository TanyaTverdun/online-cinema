@model onlineCinema.Areas.Admin.Models.PaymentListViewModel

@{
    ViewData["Title"] = Model.Title;
}

@section Styles {
    <link rel="stylesheet" href="~/css/payments.css" asp-append-version="true" />
}

<div class="container-fluid py-4 px-4">
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success bg-success bg-opacity-10 border-success text-success mb-4 fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @Model.SuccessMessage
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white fw-bold text-uppercase mb-0" style="letter-spacing: 2px;">
            <i class="bi bi-cash-stack text-danger me-2"></i> Журнал <span class="text-danger">Платежів</span>
        </h1>

        <div class="d-flex gap-2">
            @if (Model.LastId != null)
            {
                <a asp-action="Index"
                   asp-route-movie="@Model.SearchMovie"
                   asp-route-email="@Model.SearchEmail"
                   asp-route-date="@(Model.SearchDate?.ToString("yyyy-MM-dd"))"
                   class="btn btn-outline-danger btn-sm px-3">
                    <i class="bi bi-arrow-up-circle me-1"></i> На початок списку
                </a>
            }

            @if (Model.HasFilters)
            {
                <a asp-action="Index" class="btn btn-outline-light btn-sm px-3">
                    <i class="bi bi-x-lg me-1"></i> Скинути все
                </a>
            }
        </div>
    </div>

    @* Форма пошуку *@
    <div class="card border-0 mb-4 payment-dashboard">
        <div class="card-body p-3">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label text-muted small text-uppercase fw-bold">Фільм</label>
                    <input type="text" name="movie" value="@Model.SearchMovie" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small text-uppercase fw-bold">Email</label>
                    <input type="text" name="email" value="@Model.SearchEmail" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small text-uppercase fw-bold">Дата</label>
                    <input type="date" name="date" value="@(Model.SearchDate?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm bg-dark text-white datepicker-input">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-danger btn-sm w-100 fw-bold">ПОШУК</button>
                </div>
            </form>
        </div>
    </div>

    @* Таблиця *@
    <div class="card border-0 shadow-sm payment-dashboard">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 payment-table">
                <thead class="bg-black text-white text-uppercase small">
                    <tr>
                        <th class="col-date ps-4">Дата</th>
                        <th class="col-user">Користувач</th>
                        <th class="col-movie">Квитки</th>
                        <th class="col-sum">Сума</th>
                        <th class="col-status">Статус</th>
                        <th class="col-actions text-end pe-4">Дії</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in Model.Payments)
                    {
                        <tr class="clickable-row" data-bs-toggle="collapse" data-bs-target="#details-@p.PaymentId">
                            <td class="ps-4"><div class="small text-white">@p.FormattedDate</div></td>
                            <td><div class="small text-truncate">@p.UserEmail</div></td>
                            <td>
                                <div class="text-white fw-bold">@p.MovieTitle</div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-danger text-x-small font-monospace">@p.FormattedSessionDate</span>
                                    <span class="text-muted text-x-small">(@p.TicketCount квит.)</span>
                                </div>
                            </td>
                            <td><span class="fw-bold text-white">@p.Amount.ToString("N0") ₴</span></td>
                            <td>
                                @{
                                    var badgeClass = p.StatusName == "Оплачено" ? "bg-success" : "bg-secondary";
                                }
                                <span class="badge @badgeClass bg-opacity-10 border border-current px-2 py-1 text-x-small">
                                    @p.StatusName
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                @if (p.IsRefundable)
                                {
                                    <form asp-action="Refund" asp-route-id="@p.PaymentId" method="post" class="d-inline"
                                          onclick="event.stopPropagation();"
                                          onsubmit="return confirm('Ви впевнені, що хочете повернути кошти за цей платіж? Цю дію неможливо буде скасувати.');">
                                        <button type="submit" class="btn btn-outline-danger btn-action-size fw-bold text-uppercase">
                                            Повернути
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <button class="btn btn-outline-secondary btn-action-size disabled text-uppercase btn-disabled-style">Недоступно</button>
                                }
                            </td>
                        </tr>

                        <tr class="collapse details-row" id="details-@p.PaymentId">
                            <td colspan="6">
                                <div class="details-container">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-danger text-x-small text-uppercase fw-bold mb-2">Місця:</h6>
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var ticket in p.TicketsDetail)
                                                {
                                                    <li class="text-x-small text-white-50 mb-1"><i class="bi bi-geo-alt me-1"></i> @ticket</li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-info text-x-small text-uppercase fw-bold mb-2">Снеки:</h6>
                                            @if (p.SnacksDetail.Any())
                                            {
                                                <ul class="list-unstyled mb-0">
                                                    @foreach (var snack in p.SnacksDetail)
                                                    {
                                                        <li class="text-x-small text-white-50 mb-1"><i class="bi bi-check2 me-1"></i> @snack</li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <span class="text-muted text-x-small italic-text">Без снеків</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @* Пагінація *@
    @if (Model.HasNextPage)
    {
        <div class="d-flex justify-content-center mt-4 mb-5">
            <a asp-action="Index" asp-route-lastId="@Model.NextId"
               asp-route-movie="@Model.SearchMovie" asp-route-email="@Model.SearchEmail"
               asp-route-date="@(Model.SearchDate?.ToString("yyyy-MM-dd"))"
               class="btn btn-danger px-5 py-2 fw-bold text-uppercase">Завантажити ще</a>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            flatpickr(".datepicker-input", {
                theme: "dark",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                locale: "uk",
                disableMobile: "true"
            });
        });
    </script>
}